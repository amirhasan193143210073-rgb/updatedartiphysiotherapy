<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Client History</title>
  <link href="https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="css/Admin-style.css" />
  <style>
    #content nav {
      background: linear-gradient(135deg, #89d909 0%, #adf071 50%, #deedd0 100%) !important;
      color: #000000 !important;
      border-bottom: 1px solid rgba(0, 0, 0, .08);
    }
    .arrowicon { color: #000000 !important; }

    #sidebar {
      background: linear-gradient(135deg, #89d909 0%, #adf071 50%, #deedd0 100%) !important;
      color: #000000 !important;
    }
    #sidebar .brand { background: transparent !important; color: #000000 !important; }
    #sidebar .brand .bx { color: #000000 !important; }
    #sidebar .side-menu li a { background: transparent !important; color: #000000 !important; }
    #sidebar .side-menu.top li a:hover { color: #89d909 !important; }
    #sidebar .side-menu.top li.active a { color: #89d909 !important; }
    #sidebar .side-menu li.active { background: rgba(0, 0, 0, .06) !important; }

    body { font-family: Arial, sans-serif; margin: 0; color: #222; }
    .card {
      border: 1px solid #eef1f6;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
      background: #fff;
    }
    .tabs {
      display: flex;
      border-radius: 999px;
      background: #f3f4f6;
      padding: 4px;
      gap: 6px;
      margin-bottom: 18px;
      max-width: 320px;
    }
    .tab-btn {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      background: transparent;
      color: #4b5563;
      transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    }
    .tab-btn.active {
      background: linear-gradient(135deg, #89d909 0%, #adf071 50%, #deedd0 100%);
      color: #000;
      box-shadow: 0 6px 16px rgba(137,217,9,0.35);
    }

    .history-section { display: none; }
    .history-section.active { display: block; }

    .hint { color: #666; margin-bottom: 16px; font-size: 14px; }

    .table-responsive { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border: 1px solid #e5e5e5; padding: 8px; text-align: left; }
    th { background: #fafafa; }

    button.download-btn {
      cursor: pointer;
      padding: 8px 12px;
      border: 0;
      background: linear-gradient(135deg, #89d909 0%, #adf071 50%, #deedd0 100%);
      color: #000000;
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(137, 217, 9, 0.35);
      transition: background 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
      font-size: 13px;
    }
    button.download-btn:hover {
      background: linear-gradient(135deg, #89d909 0%, #89d909 100%);
      box-shadow: 0 6px 16px rgba(137, 217, 9, 0.45);
      transform: translateY(-1px);
    }

    @media (max-width: 768px) {
      #content main { padding: 16px !important; }
      .card { border-radius: 10px; }
      .tabs { width: 100%; }
    }

    @media (max-width: 680px) {
      .history-table thead { display: none; }
      .history-table tbody tr {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        padding: 12px;
        border: 1px solid #eee;
        border-radius: 10px;
        background: #fff;
        margin-bottom: 10px;
      }
      .history-table td { border: 0; padding: 0; }
      .history-table td::before {
        content: attr(data-label);
        display: block;
        font-size: 12px;
        color: #666;
        margin-bottom: 4px;
      }
    }
  </style>
  <script>
    const API_BASE = 'https://d17q6ufckg.execute-api.ap-south-1.amazonaws.com';
    const API = API_BASE.replace(/\/dev\/?$/, '');

    function switchTab(tab) {
      var tabs = document.querySelectorAll('.tab-btn');
      tabs.forEach(function (btn) {
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });

      var sections = document.querySelectorAll('.history-section');
      sections.forEach(function (sec) {
        sec.classList.toggle('active', sec.id === tab + '-section');
      });
    }

    async function loadInvoiceHistory() {
      var tbody = document.getElementById('invoice-history-body');
      if (!tbody || !API_BASE || API_BASE.includes('YOUR_API_BASE_URL')) return;
      tbody.innerHTML = '';
      try {
        var params = new URLSearchParams();
        params.set('page', '1');
        params.set('limit', '20');
        var res = await fetch(API + '/invoices?' + params.toString());
        if (!res.ok) {
          throw new Error(await res.text());
        }
        var data = await res.json();
        var items = Array.isArray(data.items) ? data.items : [];
        if (items.length === 0) {
          var emptyRow = document.createElement('tr');
          emptyRow.innerHTML = '<td colspan="4">No invoices found.</td>';
          tbody.appendChild(emptyRow);
          return;
        }
        items.forEach(function (inv) {
          var tr = document.createElement('tr');
          var d = inv.date ? new Date(inv.date) : null;
          var ds = d ? d.toLocaleDateString() : '';
          var id = inv._id || '';
          var no = inv.invoiceNumber || '';
          tr.innerHTML = `
            <td data-label="Date">${ds}</td>
            <td data-label="Patient Name">${inv.patientName || ''}</td>
            <td data-label="Invoice No.">${no}</td>
            <td data-label="Download">
              <button type="button" class="download-btn" onclick="downloadInvoiceHistoryPdf('${id}', '${no}')">Download</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) {
        var errRow = document.createElement('tr');
        errRow.innerHTML = '<td colspan="4">Failed to load invoice history.</td>';
        tbody.appendChild(errRow);
      }
    }

    async function downloadInvoiceHistoryPdf(id, invoiceNumber) {
      if (!id) return;
      try {
        var res = await fetch(API + '/invoice/' + id + '/pdf');
        if (!res.ok) {
          throw new Error(await res.text());
        }
        var blob = await res.blob();
        var filename = 'invoice-' + (invoiceNumber || id) + '.pdf';
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (e) {
        console.error('Invoice download failed', e);
      }
    }

    async function loadPrescriptionHistory() {
      var tbody = document.getElementById('prescription-body');
      if (!tbody || !API_BASE || API_BASE.includes('YOUR_API_BASE_URL')) return;
      tbody.innerHTML = '';
      try {
        var params = new URLSearchParams();
        params.set('page', '1');
        params.set('limit', '20');
        var res = await fetch(API + '/prescriptions?' + params.toString());
        if (!res.ok) {
          throw new Error(await res.text());
        }
        var data = await res.json();
        var items = Array.isArray(data.items) ? data.items : [];
        if (items.length === 0) {
          var emptyRow = document.createElement('tr');
          emptyRow.innerHTML = '<td colspan="4">No prescriptions found.</td>';
          tbody.appendChild(emptyRow);
          return;
        }
        items.forEach(function (p) {
          var tr = document.createElement('tr');
          var d = p.date ? new Date(p.date) : null;
          var ds = d ? d.toLocaleDateString() : '';
          var details = p.details || p.title || '';
          tr.innerHTML =
            '<td data-label="Date">' + ds + '</td>' +
            '<td data-label="Patient Name">' + (p.patientName || '') + '</td>' +
            '<td data-label="Details">' + details + '</td>' +
            '<td data-label="Download"><button type="button" class="download-btn" onclick="downloadPrescriptionPdf(\'' + (p._id || '') + '\')">Download</button></td>';
          tbody.appendChild(tr);
        });
      } catch (e) {
        var errRow = document.createElement('tr');
        errRow.innerHTML = '<td colspan="4">Failed to load prescription history.</td>';
        tbody.appendChild(errRow);
      }
    }

    async function downloadPrescriptionPdf(id) {
      if (!id) return;
      try {
        var res = await fetch(API + '/prescription/' + id + '/pdf');
        if (!res.ok) {
          throw new Error(await res.text());
        }
        var blob = await res.blob();
        var filename = 'prescription-' + id + '.pdf';
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (e) {
        console.error('Prescription download failed', e);
      }
    }

    window.addEventListener('DOMContentLoaded', function () {
      switchTab('prescription');
      loadPrescriptionHistory();
      loadInvoiceHistory();
    });
  </script>
</head>
<body>
  <section id="sidebar">
    <a href="#" class="brand">
      <i class='bx bxs-smile'></i>
      <span class="text">Admin Panel</span>
    </a>
    <ul class="side-menu top">
      <li>
        <a href="Blog.html">
          <i class='bx bxs-dashboard icon'></i>
          <span class="text">Dashboard</span>
        </a>
      </li>
      <li>
        <a href="SubBlog.html">
          <i class='bx bxs-image-add icon'></i>
          <span class="text">Service gallery</span>
        </a>
      </li>
      <li>
        <a href="select_section_view.html">
          <i class='bx bxs-slideshow icon'></i>
          <span class="text">section view</span>
        </a>
      </li>
      <li>
        <a href="prescription_form.html">
          <i class='bx bxs-cog icon'></i>
          <span class="text">Create Prescription</span>
        </a>
      </li>
      <li>
        <a href="invoice.html">
          <i class='bx bxs-receipt icon'></i>
          <span class="text">Create Invoice</span>
        </a>
      </li>
      <li class="active">
        <a href="Client-History.html">
          <i class='bx bxs-book-open icon'></i>
          <span class="text">Patient Record</span>
        </a>
      </li>
      <li>
        <a href="video-consultation.html">
          <i class='bx bxs-video icon'></i>
          <span class="text">Video Consultation</span>
        </a>
      </li>
      <li>
        <a href="send-video-whatsapp.html">
          <i class='bx bxs-share icon'></i>
          <span class="text">Shre Video</span>
        </a>
      </li>
    </ul>
  </section>

  <section id="content">
    <nav>
      <i class='bx bx-left-arrow-alt arrowicon'></i>
      <i class='bx bx-right-arrow-alt arrowicon' style="display: none;"></i>
    </nav>

    <main style="padding: 24px;">
      <div class="card" style="padding: 22px; max-width: 920px;">
        <h1 style="margin:0 0 4px; color:#111827; font-size: 24px;">Client History</h1>
        <p class="hint">View past prescriptions and invoices. Use the tabs to switch between history types and download records.</p>

        <div class="tabs">
          <button type="button" class="tab-btn active" data-tab="prescription" onclick="switchTab('prescription')">Prescription</button>
          <button type="button" class="tab-btn" data-tab="invoice" onclick="switchTab('invoice')">Invoice</button>
        </div>

        <div id="prescription-section" class="history-section active">
          <h2 style="margin: 0 0 8px; font-size: 18px; color:#111827;">Prescription History</h2>
          <p class="hint">List of prescriptions with date, patient name and a quick download option.</p>
          <div class="table-responsive">
            <table class="history-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Patient Name</th>
                  <th>Details</th>
                  <th>Download</th>
                </tr>
              </thead>
              <tbody id="prescription-body">
              </tbody>
            </table>
          </div>
        </div>

        <div id="invoice-section" class="history-section">
          <h2 style="margin: 16px 0 8px; font-size: 18px; color:#111827;">Invoice History</h2>
          <p class="hint">Summary of invoices with date, patient and download button. Layout mirrors invoice.html history table.</p>
          <div class="table-responsive">
            <table class="history-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Patient Name</th>
                  <th>Invoice No.</th>
                  <th>Download</th>
                </tr>
              </thead>
              <tbody id="invoice-history-body">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </section>

  <script src="js/admin-script.js"></script>
</body>
</html>
